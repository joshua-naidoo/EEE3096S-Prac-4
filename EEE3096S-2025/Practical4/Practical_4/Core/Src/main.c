/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <stdio.h>
#include "stm32f4xx.h"
#include "lcd_stm32f4.h"

/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define NS        20000
#define TIM2CLK   16000000
#define F_SIGNAL  440

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
TIM_HandleTypeDef htim2;
TIM_HandleTypeDef htim3;
DMA_HandleTypeDef hdma_tim2_ch1;

/* USER CODE BEGIN PV */
uint32_t Sine_LUT[128] = {2048, 2148, 2248, 2348, 2447, 2545, 2642, 2737, 2831, 2923, 3013, 3100, 3185, 3267, 3346, 3423, 3495, 3565, 3630, 3692, 3750, 3804, 3853, 3898, 3939, 3975, 4007, 4034, 4056, 4073, 4085, 4093, 4095, 4093, 4085, 4073, 4056, 4034, 4007, 3975, 3939, 3898, 3853, 3804, 3750, 3692, 3630, 3565, 3495, 3423, 3346, 3267, 3185, 3100, 3013, 2923, 2831, 2737, 2642, 2545, 2447, 2348, 2248, 2148, 2048, 1947, 1847, 1747, 1648, 1550, 1453, 1358, 1264, 1172, 1082, 995, 910, 828, 749, 672, 600, 530, 465, 403, 345, 291, 242, 197, 156, 120, 88, 61, 39, 22, 10, 2, 0, 2, 10, 22, 39, 61, 88, 120, 156, 197, 242, 291, 345, 403, 465, 530, 600, 672, 749, 828, 910, 995, 1082, 1172, 1264, 1358, 1453, 1550, 1648, 1747, 1847, 1947};
uint32_t Saw_LUT[128] = {0, 32, 64, 97, 129, 161, 193, 226, 258, 290, 322, 355, 387, 419, 451, 484, 516, 548, 580, 613, 645, 677, 709, 742, 774, 806, 838, 871, 903, 935, 967, 1000, 1032, 1064, 1096, 1129, 1161, 1193, 1225, 1258, 1290, 1322, 1354, 1386, 1419, 1451, 1483, 1515, 1548, 1580, 1612, 1644, 1677, 1709, 1741, 1773, 1806, 1838, 1870, 1902, 1935, 1967, 1999, 2031, 2064, 2096, 2128, 2160, 2193, 2225, 2257, 2289, 2322, 2354, 2386, 2418, 2451, 2483, 2515, 2547, 2580, 2612, 2644, 2676, 2709, 2741, 2773, 2805, 2837, 2870, 2902, 2934, 2966, 2999, 3031, 3063, 3095, 3128, 3160, 3192, 3224, 3257, 3289, 3321, 3353, 3386, 3418, 3450, 3482, 3515, 3547, 3579, 3611, 3644, 3676, 3708, 3740, 3773, 3805, 3837, 3869, 3902, 3934, 3966, 3998, 4031, 4063, 4095};
uint32_t Triangle_LUT[128] = {0, 65, 130, 195, 260, 325, 390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300, 1365, 1430, 1495, 1560, 1625, 1690, 1755, 1820, 1885, 1950, 2015, 2080, 2145, 2210, 2275, 2340, 2405, 2470, 2535, 2600, 2665, 2730, 2795, 2860, 2925, 2990, 3055, 3120, 3185, 3250, 3315, 3380, 3445, 3510, 3575, 3640, 3705, 3770, 3835, 3900, 3965, 4030, 4095, 4030, 3965, 3900, 3835, 3770, 3705, 3640, 3575, 3510, 3445, 3380, 3315, 3250, 3185, 3120, 3055, 2990, 2925, 2860, 2795, 2730, 2665, 2600, 2535, 2470, 2405, 2340, 2275, 2210, 2145, 2080, 2015, 1950, 1885, 1820, 1755, 1690, 1625, 1560, 1495, 1430, 1365, 1300, 1235, 1170, 1105, 1040, 975, 910, 845, 780, 715, 650, 585, 520, 455, 390, 325, 260, 195, 130, 65, 0};
uint32_t Piano_LUT[20000] = { 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2046, 2046, 2048, 2047, 2047, 2045, 2047, 2048, 2047, 2046, 2048, 2048, 2046, 2048, 2047, 2048, 1544, 1852, 1800, 2537, 1595, 2674, 1631, 3073, 1740, 3681, 1384, 1382, 1676, 2216, 1712, 2460, 1798, 2534, 1989, 3348, 2164, 1000, 1678, 2038, 1836, 2090, 1966, 2243, 2176, 2561, 2683, 999, 1881, 1930, 2078, 1936, 2264, 1993, 2419, 2166, 3145, 1024, 1811, 1779, 2206, 1691, 2363, 1736, 2616, 1750, 3251, 1206, 1851, 1687, 2332, 1597, 2541, 1622, 2724, 1622, 3290, 1549, 1766, 1582, 2389, 1506, 2499, 1536, 2707, 1573, 3040, 1823, 1781, 1532, 2431, 1531, 2512, 1631, 2594, 1666, 2835, 2137, 1779, 1467, 2366, 1585, 2373, 1703, 2465, 1821, 2496, 2326, 1822, 1498, 2297, 1740, 2212, 1890, 2268, 2020, 2227, 2550, 1872, 1514, 2083, 1939, 1998, 2051, 2068, 2224, 2009, 2615, 1962, 1635, 1919, 2116, 1844, 2222, 1918, 2372, 1854, 2638, 2083, 1752, 1692, 2230, 1746, 2250, 1773, 2455, 1803, 2521, 2130, 1881, 1592, 2278, 1728, 2300, 1732, 2482, 1818, 2427, 2241, 2012, 1531, 2277, 1714, 2271, 1718, 2407, 1904, 2278, 2245, 2124, 1523, 2275, 1767, 2198, 1840, 2223, 2063, 2108, 2331, 2180, 1603, 2129, 1909, 2097, 1914, 2102, 2129, 2050, 2247, 2271, 1635, 2028, 1978, 2056, 2020, 2033, 2180, 2044, 2192, 2377, 1738, 1879, 2035, 1995, 2067, 1965, 2170, 2072, 2099, 2398, 1865, 1796, 2064, 1970, 2098, 1943, 2134, 2098, 2054, 2355, 2046, 1710, 2082, 1924, 2112, 1942, 2089, 2127, 2050, 2254, 2195, 1702, 2060, 1924, 2118, 1966, 2059, 2119, 2086, 2157, 2326, 1724, 2010, 1948, 2096, 1995, 2031, 2112, 2093, 2074, 2352, 1800, 1950, 1957, 2072, 2031, 2031, 2073, 2151, 1998, 2364, 1890, 1888, 1988, 2040, 2047, 2015, 2049, 2183, 1965, 2295, 2006, 1841, 2004, 2010, 2087, 2030, 2032, 2181, 1997, 2216, 2118, 1813, 2001, 1984, 2079, 2051, 2027, 2153, 2066, 2117, 2216, 1838, 1986, 1980, 2064, 2052, 2027, 2111, 2117, 2058, 2226, 1882, 1968, 1987, 2060, 2046, 2043, 2062, 2137, 2019, 2233, 1949, 1944, 1990, 2068, 2040, 2056, 2027, 2148, 2005, 2198, 2011, 1912, 1987, 2063, 2040, 2054, 2029, 2135, 2020, 2168, 2071, 1919, 1968, 2073, 2051, 2072, 2009, 2134, 2040, 2128, 2116, 1928, 1943, 2036, 2072, 2054, 2012, 2108, 2057, 2087, 2139, 1968, 1929, 2017, 2082, 2071, 2032, 2094, 2085, 2061, 2160, 1987, 1945, 1986, 2075, 2056, 2037, 2059, 2110, 2032, 2151, 2009, 1952, 1987, 2054, 2056, 2047, 2057, 2124, 2059, 2128, 2037, 1967, 1967, 2057, 2032, 2045, 2045, 2105, 2079, 2104, 2082, 1982, 1969, 2039, 2042, 2047, 2034, 2092, 2069, 2091, 2088, 2017, 1964, 2031, 2037, 2051, 2036, 2080, 2069, 2061, 2084, 2024, 1984, 2016, 2058, 2047, 2047, 2068, 2094, 2061, 2083, 2044, 2003, 2006, 2057, 2032, 2051, 2049, 2087, 2054, 2074, 2056, 2015, 2005, 2056, 2030, 2052, 2036, 2095, 2037, 2075, 2042, 2041, 1995, 2060, 2012, 2052, 2028, 2100, 2044, 2073, 2053, 2057, 1994, 2057, 2015, 2051, 2016, 2087, 2063, 2068, 2054, 2081, 1999, 2059, 2012, 2052, 2007, 2063, 2073, 2064, 2051, 2083, 1997, 2054, 2022, 2045, 2020, 2025, 2066, 2062, 2061, 2082, 2031, 2038, 2034, 2042, 2053, 2026, 2048, 2078, 2054, 2077, 2048, 2026, 2033, 2035, 2051, 2033, 2027, 2083, 2044, 2064, 2061, 2037, 2029, 2033, 2048, 2061, 2036, 2071, 2057, 2051, 2075, 2033, 2031, 2025, 2038, 2060, 2031, 2062, 2051, 2038, 2079, 2041, 2038, 2013, 2038, 2056, 2042, 2053, 2070, 2026, 2086, 2040, 2061, 2021, 2050, 2050, 2047, 2030, 2076, 2011, 2080, 2038, 2055, 2022, 2040, 2050, 2049, 2024, 2081, 2023, 2079, 2054, 2059, 2032, 2032, 2046, 2059, 2013, 2074, 2019, 2071, 2050, 2068, 2035, 2035, 2041, 2071, 2011, 2065, 2021, 2059, 2051, 2066, 2044, 2054, 2031, 2085, 2010, 2056, 2033, 2044, 2052, 2056, 2044, 2050, 2044, 2074, 2036, 2036, 2050, 2041, 2048, 2047, 2046, 2040, 2054, 2069, 2050, 2028, 2058, 2041, 2049, 2032, 2053, 2017, 2053, 2058, 2061, 2022, 2071, 2044, 2068, 2020, 2057, 2025, 2057, 2057, 2065, 2022, 2072, 2038, 2076, 2006, 2059, 2023, 2059, 2054, 2066, 2025, 2061, 2036, 2083, 2014, 2046, 1845, 2097, 1955, 2160, 1980, 2134, 2005, 2172, 1982, 2269, 1841, 2078, 1952, 2127, 1999, 2160, 1974, 2159, 1983, 2242, 1896, 1991, 1967, 2102, 1985, 2124, 1986, 2154, 1972, 2189, 1983, 1977, 2009, 2095, 2015, 2128, 2000, 2125, 2013, 2141, 2049, 1923, 2005, 2057, 2017, 2092, 2025, 2097, 2060, 2070, 2115, 1926, 2032, 2037, 2044, 2059, 2057, 2047, 2109, 2024, 2173, 1917, 2013, 2016, 2050, 2023, 2083, 2008, 2138, 1983, 2183, 1955, 2021, 2015, 2070, 2009, 2119, 1987, 2161, 1976, 2185, 1988, 2005, 1984, 2079, 1981, 2118, 1971, 2155, 1971, 2158, 2016, 2019, 1971, 2098, 1977, 2126, 1981, 2142, 2003, 2126, 2047, 2017, 1962, 2088, 1973, 2112, 1988, 2121, 2032, 2084, 2079, 2023, 1979, 2081, 1995, 2089, 2020, 2081, 2072, 2058, 2106, 2026, 1985, 2057, 2011, 2058, 2048, 2042, 2089, 2024, 2109, 2029, 1998, 2034, 2040, 2028, 2081, 2013, 2107, 2017, 2124, 2042, 2009, 2005, 2055, 2003, 2096, 1989, 2112, 2010, 2121, 2061, 2024, 1989, 2072, 2001, 2099, 1992, 2089, 2036, 2092, 2100, 2031, 1992, 2049, 2017, 2073, 2022, 2049, 2049, 2053, 2102, 2049, 1991, 2043, 2027, 2066, 2042, 2046, 2059, 2051, 2098, 2069, 2000, 2033, 2028, 2046, 2048, 2037, 2062, 2038, 2085, 2070, 2013, 2024, 2044, 2040, 2058, 2035, 2072, 2041, 2075, 2075, 2022, 2005, 2052, 2039, 2062, 2035, 2067, 2047, 2062, 2076, 2028, 1999, 2047, 2047, 2060, 2038, 2061, 2056, 2057, 2070, 2041, 2000, 2042, 2050, 2051, 2041, 2052, 2065, 2055, 2063, 2050, 2006, 2035, 2056, 2045, 2044, 2047, 2059, 2061, 2057, 2066, 2015, 2029, 2057, 2049, 2044, 2045, 2045, 2067, 2042, 2074, 2024, 2025, 2061, 2050, 2043, 2054, 2040, 2064, 2035, 2070, 2033, 2013, 2058, 2057, 2039, 2059, 2038, 2067, 2038, 2068, 2048, 2014, 2045, 2068, 2038, 2062, 2032, 2065, 2037, 2059, 2056, 2020, 2028, 2070, 2034, 2054, 2037, 2054, 2049, 2049, 2062, 2018, 2030, 2070, 2052, 2049, 2050, 2046, 2061, 2040, 2071, 2018, 2030, 2046, 2063, 2035, 2060, 1143, 1745, 2360, 1888, 1876, 1921, 2611, 1788, 2454, 2798, 1824, 1442, 1867, 2442, 1874, 1648, 2232, 2383, 1740, 2651, 2496, 2202, 1336, 1765, 2352, 1523, 2089, 1911, 2333, 1854, 2379, 2762, 1467, 1983, 1596, 2549, 1718, 1829, 2481, 1746, 2449, 2175, 2628, 1745, 1506, 2257, 1897, 1948, 1807, 2296, 1979, 2061, 2442, 2330, 1650, 1727, 2131, 2071, 1892, 1870, 2438, 1786, 2368, 2372, 2207, 1821, 1474, 2526, 1618, 2039, 1964, 2109, 2237, 1781, 2864, 1726, 1882, 1839, 2091, 2131, 1564, 2433, 1940, 2078, 2268, 2376, 2097, 1541, 2084, 2079, 1873, 1909, 2192, 2015, 2092, 2197, 2481, 1791, 1711, 2179, 1903, 2123, 1675, 2413, 1936, 2007, 2558, 1959, 2195, 1448, 2324, 1968, 1771, 2292, 1809, 2339, 1817, 2499, 2157, 1694, 2035, 1928, 2196, 1794, 2106, 2155, 1963, 2168, 2327, 2075, 1850, 1858, 2110, 2028, 1778, 2293, 1879, 2216, 2060, 2272, 2191, 1530, 2307, 1792, 2201, 1895, 2019, 2321, 1685, 2573, 1981, 2158, 1788, 1897, 2281, 1702, 2204, 1951, 2141, 1974, 2283, 2179, 1904, 1917, 1951, 2197, 1824, 2204, 1968, 2104, 2064, 2216, 2259, 1770, 2054, 1860, 2176, 1891, 2095, 2097, 1950, 2219, 2117, 2262, 1770, 1988, 2015, 2025, 2053, 1965, 2211, 1891, 2268, 2154, 2166, 1845, 1900, 2117, 1913, 2081, 1957, 2163, 1957, 2183, 2260, 1971, 1960, 1856, 2201, 1881, 2092, 2042, 2056, 2116, 2126, 2311, 1889, 1996, 1918, 2074, 1980, 1968, 2139, 1941, 2185, 2094, 2247, 1911, 1934, 2035, 1972, 2113, 1934, 2177, 1939, 2170, 2188, 2114, 2021, 1840, 2131, 1938, 2113, 1970, 2062, 2038, 2072, 2276, 1970, 2055, 1836, 2121, 2012, 2055, 2071, 1960, 2135, 2042, 2268, 1993, 2004, 1939, 2020, 2089, 1954, 2107, 1941, 2140, 2064, 2185, 2026, 1948, 2034, 1984, 2156, 1951, 2108, 1966, 2121, 2128, 2082, 2101, 1871, 2088, 1966, 2136, 1989, 2004, 2070, 2029, 2202, 2027, 2088, 1886, 2048, 2059, 2064, 2051, 1968, 2130, 2024, 2192, 2063, 2022, 1963, 1968, 2125, 1989, 2078, 1953, 2121, 2050, 1457, 2196, 1879, 2229, 2108, 2253, 2028, 2128, 2337, 2574, 1282, 2087, 1772, 2119, 2029, 2230, 2118, 2154, 2183, 2798, 1426, 1931, 1643, 2129, 1887, 2214, 1922, 2229, 1946, 2737, 1695, 1876, 1836, 2086, 1999, 2291, 1908, 2252, 1935, 2782, 1888, 1795, 1787, 2054, 1878, 2276, 1874, 2163, 1905, 2548, 2144, 1699, 1879, 2030, 1933, 2278, 1970, 2155, 1896, 2455, 2387, 1740, 1783, 2008, 1926, 2148, 2024, 2071, 1971, 2069, 2541, 1812, 1803, 1939, 2007, 2124, 2094, 2080, 2066, 1997, 2527, 2033, 1809, 1862, 1995, 2008, 2166, 1940, 2195, 1876, 2450, 2083, 1894, 1849, 2010, 1963, 2218, 1970, 2172, 1933, 2374, 2178, 1930, 1788, 2071, 1835, 2255, 1916, 2173, 1917, 2296, 2222, 1945, 1797, 2087, 1874, 2176, 1996, 2125, 1971, 2226, 2296, 2041, 1731, 2124, 1902, 2117, 1990, 2079, 1999, 2063, 2323, 2086, 1749, 2000, 2022, 2049, 2071, 2060, 2070, 1995, 2317, 2231, 1819, 1893, 2047, 2005, 2090, 1989, 2133, 1943, 2237, 2212, 1953, 1836, 2061, 1974, 2141, 1955, 2129, 2007, 2153, 2237, 2051, 1842, 2061, 1915, 2190, 1917, 2137, 1966, 2164, 2166, 2127, 1834, 2060, 1902, 2142, 1966, 2091, 1997, 2114, 2186, 2210, 1809, 2109, 1917, 2097, 1981, 2073, 1998, 2084, 2167, 2259, 1826, 1997, 1996, 2044, 2016, 2017, 2025, 2048, 2117, 2322, 1923, 1929, 2014, 2038, 2083, 1965, 2069, 2015, 2099, 2292, 2072, 1841, 2026, 1992, 2127, 1955, 2042, 2030, 2038, 2218, 2171, 1834, 2036, 1945, 2181, 1952, 2086, 2002, 2088, 2108, 2246, 1874, 2021, 1939, 2138, 2029, 2028, 2013, 2083, 2081, 2264, 1906, 2035, 1910, 2096, 2016, 2078, 1948, 2115, 2035, 2280, 1937, 2015, 1998, 2019, 2065, 2059, 1994, 2078, 2012, 2263, 1961, 2004, 2002, 2056, 2030, 2061, 2007, 2078, 2021, 2192, 2080, 1910, 2059, 2023, 2088, 2019, 2005, 2079, 2008, 2144, 2145, 1931, 2006, 2020, 2104, 2043, 2005, 2030, 2064, 2035, 2243, 1908, 2049, 1976, 2101, 2078, 2011, 2029, 2066, 2029, 2248, 1965, 2024, 1968, 2050, 2070, 2070, 2039, 2060, 1710, 2340, 2167, 1890, 1809, 2212, 2230, 2000, 1836, 2158, 2117, 1957, 2024, 2190, 2046, 1867, 1986, 2499, 1851, 1916, 1876, 2351, 2026, 1713, 2239, 2164, 1869, 1978, 2232, 2289, 1664, 2022, 2350, 2090, 1707, 2123, 2208, 2107, 1794, 2201, 2227, 1875, 1930, 2151, 2130, 1865, 1922, 2265, 2115, 1936, 1985, 2287, 2064, 1904, 1902, 2230, 2049, 1883, 2124, 2141, 2107, 1847, 2178, 2212, 1783, 1948, 2041, 2256, 1949, 1865, 2246, 2156, 1992, 1987, 2121, 2084, 1865, 1965, 2344, 1999, 1878, 2019, 2328, 2125, 1725, 2050, 2207, 1938, 1881, 2147, 2262, 1844, 1965, 2273, 2217, 1733, 1967, 2226, 2151, 1852, 1969, 2305, 2041, 1902, 2131, 2144, 2030, 1731, 2196, 2228, 1924, 1881, 2147, 2246, 1990, 1837, 2228, 2092, 1889, 1998, 2182, 2133, 1865, 2026, 2336, 1996, 1918, 1952, 2216, 2045, 1847, 2077, 2183, 2010, 1936, 2135, 2191, 1949, 1886, 2162, 2204, 1872, 1962, 2160, 2233, 1878, 1924, 2254, 2052, 1876, 2037, 2208, 2039, 1832, 2130, 2191, 1953, 2001, 2063, 2053, 2054, 2020, 2070, 2012, 2065, 2127, 1990, 2044, 2031, 2067, 2069, 2011, 2046, 2043, 2046, 2081, 2023, 2059, 2034, 2017, 1522, 1966, 2229, 1986, 2329, 1728, 2394, 2694, 2063, 1350, 1653, 2295, 2056, 2339, 1727, 2413, 2582, 2342, 1350, 1626, 2186, 1909, 2310, 1658, 2266, 2370, 2488, 1474, 1735, 2261, 1925, 2400, 1684, 2300, 2298, 2643, 1486, 1673, 2175, 1896, 2265, 1686, 2292, 2077, 2589, 1534, 1781, 2171, 1916, 2380, 1699, 2284, 2075, 2679, 1636, 1646, 2151, 1916, 2309, 1693, 2263, 1946, 2681, 1705, 1674, 2132, 1934, 2306, 1741, 2329, 1949, 2598, 1869, 1659, 2118, 1901, 2296, 1755, 2282, 1875, 2622, 1871, 1635, 2106, 1944, 2272, 1741, 2356, 1907, 2524, 2025, 1655, 2080, 1934, 2233, 1789, 2276, 1919, 2481, 2095, 1650, 2030, 1949, 2295, 1761, 2225, 1927, 2453, 2194, 1701, 2001, 1947, 2219, 1844, 2192, 1919, 2312, 2242, 1791, 2004, 1913, 2243, 1825, 2220, 1936, 2256, 2239, 1800, 1912, 1997, 2142, 1844, 2269, 1671, 2539, 2083, 2090, 1746, 2236, 2199, 1734, 2299, 1726, 2504, 2010, 2170, 1689, 2174, 2170, 1892, 2123, 1760, 2407, 2002, 2216, 1596, 2176, 2081, 1987, 2238, 1747, 2377, 1964, 2304, 1554, 2238, 1999, 2000, 2155, 1965, 2283, 1875, 2407, 1513, 2240, 2016, 1983, 2073, 1858, 2479, 1871, 2424, 1475, 2264, 1946, 2108, 1992, 1889, 2308, 1968, 2532, 1432, 2207, 1948, 2143, 2018, 1868, 2308, 1819, 2613, 1549, 2225, 1865, 2192, 1942, 1977, 2295, 1819, 2525, 1563, 2333, 1825, 2201, 1934, 1890, 2319, 1828, 2567, 1511, 2225, 1916, 2226, 1903, 1921, 2273, 1826, 2555, 1627, 2210, 1845, 2325, 1953, 1847, 2270, 1809, 2530, 1659, 2205, 1846, 2195, 2011, 1944, 2198, 1773, 2548, 1706, 2163, 1828, 2282, 1945, 1972, 2305, 1788, 2423, 1742, 2154, 1860, 2199, 1965, 1968, 2264, 1865, 2377, 1760, 2127, 1816, 2277, 1959, 1964, 2187, 1910, 2476, 1820, 2053, 1812, 2250, 1957, 1942, 2220, 1919, 2320, 1953, 2109, 1761, 2231, 1961, 2005, 2131, 2002, 2215, 2053, 2003, 1945, 2067, 2047, 1955, 2085, 2044, 2160, 2135, 1941, 1971, 2144, 1993, 1951, 2084, 2080, 2113, 2089, 2007, 1974, 2086, 2088, 1967, 2009, 2087, 2086, 2166, 1971, 1967, 2114, 2045, 2060, 1987, 2070, 2072, 2126, 2008, 1948, 2086, 2024, 2031, 2020, 2151, 2018, 2127, 1990, 1971, 2098, 2003, 2056, 1982, 2156, 2086, 2104, 2016, 1941, 2075, 2036, 2060, 1945, 2134, 2053, 2203, 1991, 1941, 2092, 1980, 2094, 1934, 2159, 2027, 2165, 2097, 1937, 2024, 2017, 2064, 1949, 2118, 2039, 2184, 2056, 1995, 2045, 1968, 2078, 1942, 2125, 2040, 2125, 2088, 1997, 2085, 2007, 2007, 1961, 2110, 2041, 2116, 2093, 1998, 2058, 2033, 2112, 1913, 2057, 2060, 2090, 2080, 1991, 2060, 2053, 2062, 2026, 2046, 2018, 2086, 2075, 2006, 2054, 2043, 2081, 2017, 2101, 2026, 2034, 2093, 1974, 2009, 2062, 2076, 2021, 2042, 2077, 2075, 2067, 1996, 2039, 2019, 2064, 2030, 2086, 2051, 2058, 2107, 2004, 2014, 2064, 2016, 2001, 1845, 2085, 1201, 2829, 1681, 2241, 2759, 2369, 2596, 1043, 1907, 2324, 1476, 3033, 1644, 2990, 2391, 854, 2376, 1299, 2553, 2079, 1927, 2890, 2012, 1689, 1592, 2018, 2429, 1663, 2750, 1899, 2873, 1306, 1624, 2267, 1692, 2390, 2079, 2014, 3126, 759, 2395, 1543, 2354, 2064, 1971, 2536, 2418, 1592, 1763, 1709, 2486, 1441, 2720, 1801, 2743, 1652, 1534, 2222, 1878, 2059, 2402, 1743, 3117, 1277, 2011, 1791, 1961, 2171, 1996, 2270, 2448, 1781, 1843, 1659, 2404, 1592, 2595, 1941, 2399, 2243, 1371, 2196, 1818, 1981, 2405, 1716, 2782, 1858, 1738, 1955, 1864, 2255, 1968, 2249, 2258, 2220, 1744, 1713, 2239, 1853, 2162, 2195, 1943, 2660, 1301, 2077, 1963, 1951, 2339, 1863, 2382, 2354, 1544, 2064, 1724, 2344, 1818, 2321, 2051, 2352, 1829, 1711, 2140, 1968, 1951, 2410, 1794, 2748, 1534, 1898, 2068, 1900, 2158, 2051, 2092, 2496, 1653, 2052, 1781, 2244, 1856, 2247, 2098, 2274, 2037, 1669, 2022, 2116, 1815, 2483, 1728, 2565, 1950, 1686, 2138, 1901, 2088, 2184, 1961, 2464, 1963, 1843, 1894, 2093, 1948, 2180, 2043, 2240, 2215, 1687, 2004, 2079, 1940, 2174, 2039, 2200, 2280, 1654, 2008, 2031, 1961, 2112, 2003, 2213, 2258, 1808, 2001, 1988, 2210, 1958, 2147, 1962, 2410, 1740, 1954, 2100, 1967, 2210, 2031, 1983, 2285, 1809, 1969, 2025, 2148, 1951, 2273, 1983, 2280, 1842, 1927, 2006, 2120, 2032, 2131, 2042, 2324, 1860, 1749, 2102, 2053, 2005, 2224, 1939, 2432, 1951, 1811, 1971, 2088, 2027, 2095, 2084, 2214, 2116, 1850, 1946, 2058, 2005, 2150, 1958, 2270, 2066, 1832, 2096, 2028, 1949, 2146, 2031, 2196, 2070, 1827, 2037, 2155, 2016, 1996, 2090, 2125, 2186, 1836, 1984, 2120, 2064, 2042, 2039, 2046, 2244, 1752, 2023, 2113, 2039, 2156, 2004, 2033, 2164, 1878, 2032, 2001, 2167, 2010, 2184, 2025, 2089, 1925, 1881, 2144, 2051, 2079, 2140, };
uint32_t Drum_LUT[128] = {2203, 2034, 2054, 2049, 2043, 2049, 2043, 2052, 2047, 2045, 2042, 2049, 2038, 2055, 2039, 2047, 2046, 2046, 2048, 2056, 2049, 2051, 2039, 2049, 2033, 2053, 2044, 2056, 2042, 2047, 2038, 2043, 2031, 2053, 2041, 2060, 2040, 2056, 2046, 2056, 2039, 2065, 2042, 2057, 2027, 1855, 1979, 2287, 2198, 1453, 1964, 3213, 4095, 2366, 0, 123, 0, 2870, 4095, 4095, 3130, 34, 108, 0, 2109, 4071, 4067, 4080, 3107, 1037, 321, 702, 2026, 2761, 2086, 821, 217, 538, 1191, 1883, 1771, 1618, 1363, 1814, 1616, 1769, 2348, 2758, 3145, 3482, 3544, 3664, 3996, 4078, 3990, 3546, 2771, 2371, 2152, 2144, 2036, 1841, 916, 0, 23, 0, 25, 0, 469, 1139, 1710, 2581, 2814, 2710, 2646, 2519, 2400, 3032, 3261, 3301, 3357, 3172, 2887, 3344, 3595, 3742, 3779, 3114};
uint32_t Guitar_LUT[128] = {2738, 2882, 2691, 2874, 1717, 1794, 1380, 2081, 2602, 1307, 1847, 1686, 1842, 2047, 2823, 2660, 2117, 2756, 1631, 1479, 1569, 2023, 2020, 1652, 2277, 1937, 2381, 2504, 2413, 2116, 1819, 1809, 1491, 1856, 1576, 2453, 2282, 1818, 2643, 2412, 2189, 1913, 2095, 1532, 1805, 2284, 1623, 1790, 2129, 2804, 2282, 2223, 2163, 1530, 1921, 1937, 2082, 1856, 1997, 2022, 2142, 2303, 2227, 2704, 1648, 1670, 2026, 1740, 1844, 1992, 2336, 2011, 2554, 2379, 1760, 1764, 2124, 2271, 1555, 2012, 1759, 1808, 2344, 2343, 2416, 2122, 2205, 1918, 1843, 1692, 1990, 2132, 1596, 2309, 2360, 2216, 2155, 2206, 2121, 1833, 2237, 1765, 1468, 1849, 2468, 2232, 1999, 2375, 1889, 2144, 2194, 2055, 1886, 1747, 1996, 1922, 2009, 2137, 2507, 2055, 1884, 2283, 1967, 1888, 1854, 2064, 1991, 2056};


uint32_t TIM2_Ticks = 16000000 / (128 * 440); 
uint32_t DestAddress = (uint32_t) &(TIM3->CCR3);

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_TIM2_Init(void);
static void MX_TIM3_Init(void);
/* USER CODE BEGIN PFP */
void EXTI0_IRQHandler(void);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_TIM2_Init();
  MX_TIM3_Init();
  /* USER CODE BEGIN 2 */
  init_LCD();
  lcd_putstring("Sine");

  HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_3);
  HAL_TIM_OC_Start(&htim2, TIM_CHANNEL_1);
  HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Sine_LUT, DestAddress, NS);
  __HAL_TIM_ENABLE_DMA(&htim2, TIM_DMA_CC1);

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE3);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_NONE;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_HSI;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_0) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{
  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};
  TIM_OC_InitTypeDef sConfigOC = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 0;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = TIM2_Ticks - 1;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_TIM_OC_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sConfigOC.OCMode = TIM_OCMODE_TIMING;
  sConfigOC.Pulse = 0;
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  if (HAL_TIM_OC_ConfigChannel(&htim2, &sConfigOC, TIM_CHANNEL_1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */
  __HAL_RCC_DMA1_CLK_ENABLE();

  hdma_tim2_ch1.Instance = DMA1_Stream5;
  hdma_tim2_ch1.Init.Channel = DMA_CHANNEL_3;
  hdma_tim2_ch1.Init.Direction = DMA_MEMORY_TO_PERIPH;
  hdma_tim2_ch1.Init.PeriphInc = DMA_PINC_DISABLE;
  hdma_tim2_ch1.Init.MemInc = DMA_MINC_ENABLE;
  hdma_tim2_ch1.Init.PeriphDataAlignment = DMA_PDATAALIGN_WORD;
  hdma_tim2_ch1.Init.MemDataAlignment = DMA_MDATAALIGN_WORD;
  hdma_tim2_ch1.Init.Mode = DMA_CIRCULAR;
  hdma_tim2_ch1.Init.Priority = DMA_PRIORITY_HIGH;
  hdma_tim2_ch1.Init.FIFOMode = DMA_FIFOMODE_DISABLE;

  if (HAL_DMA_Init(&hdma_tim2_ch1) != HAL_OK)
  {
      Error_Handler();
  }

  __HAL_LINKDMA(&htim2, hdma[TIM_DMA_ID_CC1], hdma_tim2_ch1);
  /* USER CODE END TIM2_Init 2 */

}

/**
  * @brief TIM3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM3_Init(void)
{
  /* USER CODE BEGIN TIM3_Init 0 */

  /* USER CODE END TIM3_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};
  TIM_OC_InitTypeDef sConfigOC = {0};

  /* USER CODE BEGIN TIM3_Init 1 */

  /* USER CODE END TIM3_Init 1 */
  htim3.Instance = TIM3;
  htim3.Init.Prescaler = 0;
  htim3.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim3.Init.Period = 4095;
  htim3.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim3.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim3) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim3, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_TIM_PWM_Init(&htim3) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim3, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sConfigOC.OCMode = TIM_OCMODE_PWM1;
  sConfigOC.Pulse = 0;
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  if (HAL_TIM_PWM_ConfigChannel(&htim3, &sConfigOC, TIM_CHANNEL_3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM3_Init 2 */

  /* USER CODE END TIM3_Init 2 */
  HAL_TIM_MspPostInit(&htim3);

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{
  __HAL_RCC_DMA1_CLK_ENABLE();

  HAL_NVIC_SetPriority(DMA1_Stream5_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Stream5_IRQn);

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  /* USER CODE BEGIN MX_GPIO_Init_1 */

  /* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();

  // LCD pins configuration
  GPIO_InitStruct.Pin = GPIO_PIN_14 | GPIO_PIN_15;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  GPIO_InitStruct.Pin = GPIO_PIN_8 | GPIO_PIN_9;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

  GPIO_InitStruct.Pin = GPIO_PIN_12 | GPIO_PIN_15;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  HAL_GPIO_WritePin(GPIOC, GPIO_PIN_14 | GPIO_PIN_15, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(GPIOB, GPIO_PIN_8 | GPIO_PIN_9, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_12 | GPIO_PIN_15, GPIO_PIN_RESET);

  // Button0 configuration (PA0)
  GPIO_InitStruct.Pin = Button0_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_PULLUP;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  HAL_NVIC_SetPriority(EXTI0_IRQn, 2, 0);
  HAL_NVIC_EnableIRQ(EXTI0_IRQn);

  /* USER CODE BEGIN MX_GPIO_Init_2 */
  /* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */
void EXTI0_IRQHandler(void){
  static uint32_t lastTick = 0;
  if (HAL_GetTick() - lastTick < 50) {
    HAL_GPIO_EXTI_IRQHandler(Button0_Pin);
    return;
  }
  lastTick = HAL_GetTick();

  HAL_DMA_Abort_IT(&hdma_tim2_ch1);

  static uint32_t lutIndex = 0;
  lutIndex = (lutIndex + 1) % 6;

  switch (lutIndex) {
    case 0:
      HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Sine_LUT, DestAddress, 128);
      lcd_update_line("Sine");
      break;
    case 1:
      HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Saw_LUT, DestAddress, 128);
      lcd_update_line("Saw");
      break;
    case 2:
      HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Triangle_LUT, DestAddress, 128);
      lcd_update_line("Triangle");
      break;
    case 3:
      HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Piano_LUT, DestAddress, 20000);
      lcd_update_line("Piano");
      break;
    case 4:
      HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Drum_LUT, DestAddress, 128);
      lcd_update_line("Drum");
      break;
    case 5:
      HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Guitar_LUT, DestAddress, 128);
      lcd_update_line("Guitar");
      break;
  }

  HAL_GPIO_EXTI_IRQHandler(Button0_Pin);
}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
